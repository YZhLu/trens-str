import{g as M,s as B,n as z,o as G,r as J}from"../chunks/scheduler.D8z-aaqU.js";import{S as K,i as O,e as y,s as E,H as X,a as q,r as H,o as k,b as V,u as Y,f as v,h as b,v as Z,l as W,n as x,g,p as $,w as P,x as U,q as ee,y as N}from"../chunks/index.Cp-pqOvB.js";import{e as A}from"../chunks/each.D6YF6ztN.js";import{w as te}from"../chunks/index.DeJYhIJ1.js";const se=new Error("request for lock canceled");var ie=function(t,e,s,i){function r(o){return o instanceof s?o:new s(function(d){d(o)})}return new(s||(s=Promise))(function(o,d){function l(f){try{u(i.next(f))}catch(_){d(_)}}function h(f){try{u(i.throw(f))}catch(_){d(_)}}function u(f){f.done?o(f.value):r(f.value).then(l,h)}u((i=i.apply(t,e||[])).next())})};class C{constructor(e,s=se){this._value=e,this._cancelError=s,this._queue=[],this._weightedWaiters=[]}acquire(e=1,s=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((i,r)=>{const o={resolve:i,reject:r,weight:e,priority:s},d=R(this._queue,l=>s<=l.priority);d===-1&&e<=this._value?this._dispatchItem(o):this._queue.splice(d+1,0,o)})}runExclusive(e){return ie(this,arguments,void 0,function*(s,i=1,r=0){const[o,d]=yield this.acquire(i,r);try{return yield s(o)}finally{d()}})}waitForUnlock(e=1,s=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return this._couldLockImmediately(e,s)?Promise.resolve():new Promise(i=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),ne(this._weightedWaiters[e-1],{resolve:i,priority:s})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatchQueue()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatchQueue()}cancel(){this._queue.forEach(e=>e.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(e){const s=this._value;this._value-=e.weight,e.resolve([s,this._newReleaser(e.weight)])}_newReleaser(e){let s=!1;return()=>{s||(s=!0,this.release(e))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let e=this._value;e>0;e--){const s=this._weightedWaiters[e-1];s&&(s.forEach(i=>i.resolve()),this._weightedWaiters[e-1]=[])}else{const e=this._queue[0].priority;for(let s=this._value;s>0;s--){const i=this._weightedWaiters[s-1];if(!i)continue;const r=i.findIndex(o=>o.priority<=e);(r===-1?i:i.splice(0,r)).forEach(o=>o.resolve())}}}_couldLockImmediately(e,s){return(this._queue.length===0||this._queue[0].priority<s)&&e<=this._value}}function ne(t,e){const s=R(t,i=>e.priority<=i.priority);t.splice(s+1,0,e)}function R(t,e){for(let s=t.length-1;s>=0;s--)if(e(t[s]))return s;return-1}const ae=1e3,T=te([{number:1,speed:1e3,position:0,path:[1,2,3,4]},{number:2,speed:1e3,position:0,path:[5,6,7,3]},{number:3,speed:1e3,position:0,path:[10,8,4,9]},{number:4,speed:1e3,position:0,path:[11,12,9,7]}]),re=new C(1),oe=new C(1),le=new C(1),ue=new C(1),D=new C(3),L={7:re,9:oe,3:le,4:ue};let Q=0;async function S(t,e){var d;const s=((d=M(T).find(l=>l.number===t.number))==null?void 0:d.speed)||1e3,i=ae/s*1e3;console.log(`Step ${Q} - train ${t.number} - Trilho ${e} - Velocidade ${s} m/s`),Q++;const r=50;let o=0;for(;o<i;)T.update(l=>{const h=l.find(u=>u.number===t.number);return h&&(h.position=e),[...l]}),await de(r),o+=r;console.log(`Trem ${t.number} concluiu a travessia do trilho ${e}`)}async function he(t){for(;;)await S(t,t.path[0]),await S(t,t.path[1]),await D.acquire(),await L[`${t.path[2]}`].acquire(),console.log(`Linha ${t.path[2]} ocupada pelo trem ${t.number}`),await S(t,t.path[2]),await L[`${t.path[3]}`].acquire(),L[`${t.path[2]}`].release(),console.log(`Linha ${t.path[3]} ocupada pelo trem ${t.number}`),console.log(`Linha ${t.path[2]} liberada`),await S(t,t.path[3]),L[`${t.path[3]}`].release(),console.log(`Linha ${t.path[3]} liberada`),D.release()}async function ce(){const t=M(T);for(const e of t)he(e)}function de(t){return new Promise(e=>setTimeout(e,t))}function pe(t,e){T.update(s=>{const i=s.find(r=>r.number===t);return i&&(i.speed=e),[...s]})}function j(t,e,s){const i=t.slice();return i[4]=e[s],i[5]=e,i[6]=s,i}function F(t){let e,s,i,r=t[4].number+"",o,d,l,h,u,f,_,w,c;function n(){t[2].call(u,t[5],t[6])}function m(...a){return t[3](t[4],...a)}return{c(){e=y("div"),s=y("label"),i=W("Trem "),o=W(r),d=W(" Velocidade:"),h=E(),u=y("input"),_=E(),this.h()},l(a){e=q(a,"DIV",{});var p=V(e);s=q(p,"LABEL",{for:!0});var I=V(s);i=x(I,"Trem "),o=x(I,r),d=x(I," Velocidade:"),I.forEach(v),h=k(p),u=q(p,"INPUT",{id:!0,type:!0,min:!0,max:!0}),_=k(p),p.forEach(v),this.h()},h(){g(s,"for",l="speed-"+t[4].number),g(u,"id",f="speed-"+t[4].number),g(u,"type","number"),g(u,"min","100"),g(u,"max","5000")},m(a,p){b(a,e,p),$(e,s),$(s,i),$(s,o),$(s,d),$(e,h),$(e,u),P(u,t[4].speed),$(e,_),w||(c=[U(u,"input",n),U(u,"change",m)],w=!0)},p(a,p){t=a,p&1&&r!==(r=t[4].number+"")&&ee(o,r),p&1&&l!==(l="speed-"+t[4].number)&&g(s,"for",l),p&1&&f!==(f="speed-"+t[4].number)&&g(u,"id",f),p&1&&N(u.value)!==t[4].speed&&P(u,t[4].speed)},d(a){a&&v(e),w=!1,J(c)}}}function fe(t){let e,s="Simulação de Trens",i,r,o,d=_e()+"",l,h,u="Ajuste a Velocidade dos Trens",f,_,w=A(t[0]),c=[];for(let n=0;n<w.length;n+=1)c[n]=F(j(t,w,n));return{c(){e=y("h1"),e.textContent=s,i=E(),r=y("div"),o=new X(!1),l=E(),h=y("h2"),h.textContent=u,f=E(),_=y("div");for(let n=0;n<c.length;n+=1)c[n].c();this.h()},l(n){e=q(n,"H1",{"data-svelte-h":!0}),H(e)!=="svelte-do0li1"&&(e.textContent=s),i=k(n),r=q(n,"DIV",{});var m=V(r);o=Y(m,!1),m.forEach(v),l=k(n),h=q(n,"H2",{"data-svelte-h":!0}),H(h)!=="svelte-1kr2yex"&&(h.textContent=u),f=k(n),_=q(n,"DIV",{});var a=V(_);for(let p=0;p<c.length;p+=1)c[p].l(a);a.forEach(v),this.h()},h(){o.a=null},m(n,m){b(n,e,m),b(n,i,m),b(n,r,m),o.m(d,r),b(n,l,m),b(n,h,m),b(n,f,m),b(n,_,m);for(let a=0;a<c.length;a+=1)c[a]&&c[a].m(_,null)},p(n,[m]){if(m&3){w=A(n[0]);let a;for(a=0;a<w.length;a+=1){const p=j(n,w,a);c[a]?c[a].p(p,m):(c[a]=F(p),c[a].c(),c[a].m(_,null))}for(;a<c.length;a+=1)c[a].d(1);c.length=w.length}},i:z,o:z,d(n){n&&(v(e),v(i),v(r),v(l),v(h),v(f),v(_)),Z(c,n)}}}function _e(){return`
            <svg width="${200+50*2}" height="${200+50*2}">
                <rect x="50" y="50" width="200" height="200" stroke="black" fill="none" />
            </svg>
        `}function me(t,e,s){let i=[];T.subscribe(l=>s(0,i=l));function r(l,h){const u=parseInt(l.target.value);pe(h,u)}G(()=>{ce()});function o(l,h){l[h].speed=N(this.value),s(0,i)}return[i,r,o,(l,h)=>r(h,l.number)]}class $e extends K{constructor(e){super(),O(this,e,me,fe,B,{})}}export{$e as component};
